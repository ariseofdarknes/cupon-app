<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ডিসকাউন্ট কুপন জেনারেটর ও ভ্যালিডেটর</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
        }
        .coupon-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .coupon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .coupon-card.used {
            background-color: #e5e7eb; /* gray-200 */
            opacity: 0.7;
        }
        .nav-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
         #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4f46e5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ডিসকাউন্ট কুপন ম্যানেজমেন্ট</h1>
            <p class="text-gray-600 mt-2">আপনার ব্যবসার জন্য সহজেই কুপন তৈরি, পরিচালনা ও ভ্যালিডেট করুন।</p>
        </header>

                <div class="mb-8 flex justify-center border-b border-gray-200">
            <button id="show-generator-btn" class="nav-btn active py-3 px-6 font-semibold text-gray-600 hover:text-indigo-600 focus:outline-none">কুপন জেনারেটর</button>
            <button id="show-validator-btn" class="nav-btn py-3 px-6 font-semibold text-gray-600 hover:text-indigo-600 focus:outline-none">কুপন ভ্যালিডেটর</button>
        </div>

                <main id="generator-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">কুপন তৈরি করুন</h2>
                <form id="coupon-form" class="space-y-4">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">শিরোনাম</label>
                        <input type="text" id="title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="বিশেষ ছাড়!" required>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">বিবরণ</label>
                        <textarea id="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>এই কুপনটি ব্যবহার করে বিশেষ ছাড় উপভোগ করুন।</textarea>
                    </div>
                    <div>
                        <label for="discount" class="block text-sm font-medium text-gray-700">ডিসকাউন্ট (%)</label>
                        <input type="number" id="discount" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="10" min="1" max="100" required>
                    </div>
                    <div>
                        <label for="min-purchase" class="block text-sm font-medium text-gray-700">ন্যূনতম ক্রয়ের পরিমাণ (টাকা)</label>
                        <input type="number" id="min-purchase" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="500" min="0" required>
                    </div>
                    <div>
                        <label for="expiry-date" class="block text-sm font-medium text-gray-700">মেয়াদ শেষ হওয়ার তারিখ</label>
                        <input type="datetime-local" id="expiry-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">কতগুলো কোড বানাবেন?</label>
                        <input type="number" id="quantity" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="10" min="1" max="50" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-semibold">
                        জেনারেট করুন
                    </button>
                </form>
            </div>

                        <div class="lg:col-span-2">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">তৈরি করা কুপনসমূহ</h2>
                    <p class="text-gray-600">UserID: <span id="userId-display" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                </div>
                <div id="coupons-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p id="no-coupons-msg" class="text-gray-500 col-span-full text-center py-10">এখনও কোনো কুপন তৈরি করা হয়নি।</p>
                </div>
            </div>
        </main>
        
                <section id="validator-view" class="hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-center mb-6">কুপন রিডিম করুন</h2>
                <form id="validator-form">
                    <label for="redeem-code-input" class="block text-sm font-medium text-gray-700">কুপন কোড লিখুন</label>
                    <input type="text" id="redeem-code-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 text-center text-2xl font-mono tracking-widest focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="CODE123" required>
                    <button type="submit" class="mt-4 w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        কোড যাচাই করুন
                    </button>
                </form>
                <div id="validator-result" class="mt-6 text-center"></div>
            </div>
        </section>
    </div>

    <script type="module">
        // --- Firebase SDKs ইম্পোর্ট করা হচ্ছে (ভার্সন 12.4.0) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- আপনার Firebase কনফিগারেশন: আপনার Firebase অ্যাকাউন্টের সাথে যুক্ত! ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxzl1jPy7PPAnTw_EGfpE7XdbA0Do1eYU",
            authDomain: "cupon-genarator.firebaseapp.com",
            projectId: "cupon-genarator",
            storageBucket: "cupon-genarator.firebasestorage.app",
            messagingSenderId: "504052398987",
            appId: "1:504052398987:web:61f63ba0f6abd719444d8e",
            measurementId: "G-R6DHYH0CN5"
        };

        // --- প্রয়োজনীয় ভ্যারিয়েবল সেট করা হয়েছে ---
        const appId = 'default-coupon-app'; // আপনার কুপন অ্যাপ্লিকেশনের আইডি (Firestore পাথ-এর জন্য)
        // initialAuthToken লজিক অপ্রয়োজনীয় হওয়ায় বাদ দেওয়া হয়েছে
        
        // --- DOM এলিমেন্টস ধরা হচ্ছে ---
        const couponForm = document.getElementById('coupon-form');
        const couponsContainer = document.getElementById('coupons-container');
        const noCouponsMsg = document.getElementById('no-coupons-msg');
        const expiryDateInput = document.getElementById('expiry-date');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('userId-display');
        
        const generatorView = document.getElementById('generator-view');
        const validatorView = document.getElementById('validator-view');
        const showGeneratorBtn = document.getElementById('show-generator-btn');
        const showValidatorBtn = document.getElementById('show-validator-btn');
        const validatorForm = document.getElementById('validator-form');
        const redeemCodeInput = document.getElementById('redeem-code-input');
        const validatorResult = document.getElementById('validator-result');

        // --- Firebase ইনিশিয়ালাইজেশন ---
        let db, auth, userId;
        
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        // Analytics এর প্রয়োজন নেই, তাই getAnalytics() কলটি বাদ দেওয়া হয়েছে।
       

        // --- অথেন্টিকেশন এবং ডেটা লোড ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                listenForCoupons();
            } else {
                try {
                    // কাস্টম টোকেন লজিক বাদ দেওয়ায় সরাসরি অ্যানোনিমাস সাইন-ইন
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication failed: ", error);
                }
            }
        });
        
        // --- নেভিগেশন ট্যাব পরিবর্তন ---
        showGeneratorBtn.addEventListener('click', () => {
            generatorView.style.display = 'grid';
            validatorView.classList.add('hidden');
            showGeneratorBtn.classList.add('active');
            showValidatorBtn.classList.remove('active');
        });
        showValidatorBtn.addEventListener('click', () => {
            generatorView.style.display = 'none';
            validatorView.classList.remove('hidden');
            showValidatorBtn.classList.add('active');
            showGeneratorBtn.classList.remove('active');
        });

        // --- ডিফল্ট এক্সপায়ারি ডেট সেট করা (আজ থেকে ৭ দিন পর) ---
        const setDefaultExpiryDate = () => {
            const now = new Date();
            now.setDate(now.getDate() + 7);
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            expiryDateInput.value = now.toISOString().slice(0, 16);
        };
        setDefaultExpiryDate();

        const generateRandomCode = (length = 6) => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };
        
        couponForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                alert("ব্যবহারকারী অথেন্টিকেট করা হয়নি।");
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                discount: parseInt(document.getElementById('discount').value, 10),
                minPurchase: parseInt(document.getElementById('min-purchase').value, 10),
                expiryDate: new Date(document.getElementById('expiry-date').value).toISOString(),
            };
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const couponCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/coupons`);
            const promises = [];
            for (let i = 0; i < quantity; i++) {
                promises.push(addDoc(couponCollectionRef, {
                    ...formData,
                    code: generateRandomCode(6),
                    isUsed: false,
                    createdAt: new Date().toISOString(),
                }));
            }
            try {
                await Promise.all(promises);
            } catch (error) {
                console.error("কুপন তৈরিতে ত্রুটি:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        const listenForCoupons = () => {
            if (!userId) return;
            const couponCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/coupons`);
            const q = query(couponCollectionRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                couponsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    couponsContainer.appendChild(noCouponsMsg);
                    noCouponsMsg.style.display = 'block';
                } else {
                    noCouponsMsg.style.display = 'none';
                    querySnapshot.forEach((doc) => {
                        createCouponCard({ id: doc.id, ...doc.data() });
                    });
                }
            });
        };

        const createCouponCard = (coupon) => {
            const card = document.createElement('div');
            card.className = `coupon-card bg-white p-5 rounded-lg shadow-md border-l-4 ${coupon.isUsed ? 'border-gray-400 used' : 'border-indigo-500'}`;
            const expiry = new Date(coupon.expiryDate);
            const isExpired = new Date() > expiry;
            let statusText, statusColor;
            if (coupon.isUsed) {
                statusText = 'ব্যবহৃত';
                statusColor = 'bg-red-500';
            } else if (isExpired) {
                statusText = 'মেয়াদোত্তীর্ণ';
                statusColor = 'bg-yellow-500';
            } else {
                statusText = 'সক্রিয়';
                statusColor = 'bg-green-500';
            }
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div><h3 class="text-xl font-bold text-gray-800">${coupon.title}</h3><p class="text-sm text-gray-500">${coupon.description}</p></div>
                    <span class="text-white text-xs font-semibold px-2.5 py-1 rounded-full ${statusColor}">${statusText}</span>
                </div>
                <div class="my-4 text-center bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-600">ডিসকাউন্ট কোড</p><p class="text-3xl font-mono tracking-widest font-bold text-indigo-600">${coupon.code}</p></div>
                <div class="flex justify-center my-4"><div id="qr-${coupon.id}" class="p-2 bg-white border rounded"></div></div>
                <div class="text-sm text-gray-600 space-y-2 border-t pt-4">
                    <p><strong>${coupon.discount}%</strong> ছাড়, ন্যূনতম <strong>${coupon.minPurchase}</strong> টাকার কেনাকাটায়।</p>
                    <p>মেয়াদ: ${expiry.toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: 'numeric' })}</p>
                </div>`;
            couponsContainer.appendChild(card);
            new QRCode(document.getElementById(`qr-${coupon.id}`), {
                text: coupon.code, width: 128, height: 128, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
            });
        };
        
        // --- কুপন ভ্যালিডেশন এবং রিডিম করার লজিক ---
        validatorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const enteredCode = redeemCodeInput.value.trim().toUpperCase();
            if (!enteredCode || !userId) return;

            loadingOverlay.classList.remove('hidden');
            validatorResult.innerHTML = '';

            const couponCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/coupons`);
            const q = query(couponCollectionRef, where("code", "==", enteredCode), limit(1));
            
            try {
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    validatorResult.innerHTML = `<p class="text-red-500 font-semibold">দুঃখিত, এই কোডটি সঠিক নয়।</p>`;
                    return;
                }

                const couponDoc = querySnapshot.docs[0];
                const couponData = couponDoc.data();
                const expiry = new Date(couponData.expiryDate);

                if (couponData.isUsed) {
                    validatorResult.innerHTML = `<p class="text-yellow-600 font-semibold">এই কুপনটি ইতিমধ্যে ব্যবহার করা হয়ে গেছে।</p>`;
                } else if (new Date() > expiry) {
                    validatorResult.innerHTML = `<p class="text-yellow-600 font-semibold">এই কুপনটির মেয়াদ শেষ হয়ে গেছে।</p>`;
                } else {
                    // কোডটি সফলভাবে ব্যবহার করা হলো, এখন ডেটাবেস আপডেট হবে
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/coupons`, couponDoc.id), {
                        isUsed: true
                    });
                    validatorResult.innerHTML = `<div class="p-4 bg-green-100 border-l-4 border-green-500 rounded-r-lg">
                        <h4 class="text-lg font-bold text-green-800">কুপন সফলভাবে প্রয়োগ করা হয়েছে!</h4>
                        <p class="text-green-700">${couponData.discount}% ছাড় প্রযোজ্য হবে।</p>
                    </div>`;
                    redeemCodeInput.value = ''; // ইনপুট ফিল্ড খালি করা
                }
            } catch (error) {
                console.error("কোড যাচাই করতে সমস্যা হয়েছে:", error);
                validatorResult.innerHTML = `<p class="text-red-500 font-semibold">একটি সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।</p>`;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

    </script>
</body>
</html>