<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ডিসকাউন্ট কুপন জেনারেটর ও ভ্যালিডেটর</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styling for the downloadable coupon card (to match the large format) */
        .coupon-card-download {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Emerald Gradient */
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            margin: 1.5rem auto; /* Adjusted margin for separation */
            max-width: 480px; /* Increased from 420px for larger card and better text spacing */
            width: 100%;
            overflow: hidden; /* Prevents overflow issues */
            /* Ensure line-height is good for readability */
            line-height: 1.4;
        }
        .coupon-card-download:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1.5'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            border-radius: 1rem;
        }
        .coupon-content-wrapper {
            position: relative;
            z-index: 10;
        }
        .tab-btn.active {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .qr-code-large canvas {
            background-color: white !important;
            padding: 0.5rem;
            border-radius: 0.5rem;
            /* html2canvas fix: ensure canvas content is properly sized */
            width: 128px !important;
            height: 128px !important;
        }
        /* Fix for coupon code font size in small screens */
        @media (max-width: 480px) {
            .coupon-card-download .text-4xl {
                font-size: 2.25rem; /* Slightly smaller for mobile */
            }
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 border-b-4 border-emerald-500 pb-2 inline-block">কুপন ম্যানেজমেন্ট সিস্টেম</h1>
            <p class="text-gray-600 mt-2 text-lg font-medium">[ Owner : WideFind ]</p>
            <p class="text-gray-600 mt-2">ডিসকাউন্ট কুপন তৈরি, ভ্যালিডেট এবং তালিকা দেখুন।</p>
        </header>

        <div class="flex justify-center mb-8">
            <button id="tabGenerate" class="tab-btn active px-6 py-2 rounded-l-lg font-semibold text-gray-700 bg-white border border-gray-300 hover:bg-emerald-100 transition duration-150">
                কুপন তৈরি করুন
            </button>
            <button id="tabValidate" class="tab-btn px-6 py-2 font-semibold text-gray-700 bg-white border-y border-gray-300 hover:bg-emerald-100 transition duration-150">
                কুপন ভ্যালিডেট করুন
            </button>
            <button id="tabList" class="tab-btn px-6 py-2 rounded-r-lg font-semibold text-gray-700 bg-white border border-gray-300 hover:bg-emerald-100 transition duration-150">
                কুপন তালিকা
            </button>
        </div>

        <div id="contentArea" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            </div>

        <footer class="mt-8 text-center text-sm text-gray-500 p-4 bg-white rounded-xl shadow-md">
            <p>আপনার ইউজার আইডি (অন্যান্য ব্যবহারকারীদের সাথে শেয়ার করুন):</p>
            <p id="userIdDisplay" class="font-mono text-base text-emerald-600 break-all mt-1"></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        // আপনার দেওয়া আসল Firebase কনফিগারেশন কোড এখানে যোগ করা হয়েছে
        const firebaseConfig = {
            apiKey: "AIzaSyAxzl1jPy7PPAnTw_EGfpE7XdbA0Do1eYU",
            authDomain: "cupon-genarator.firebaseapp.com",
            databaseURL: "https://cupon-genarator-default-rtdb.firebaseio.com",
            projectId: "cupon-genarator",
            storageBucket: "cupon-genarator.firebasestorage.app",
            messagingSenderId: "504052398987",
            appId: "1:504052398987:web:61f63ba0f6abd719444d8e",
            measurementId: "G-R6DHYH0CN5"
        };
        
        const appId = firebaseConfig.appId; // কনফিগারেশন থেকে appId নেওয়া হয়েছে
        let db, auth, userId = null;
        
        // --- Global Variables for UI State Persistence & Download ---
        let lastTitle = 'ঈদ স্পেশাল ডিসকাউন্ট';
        let lastDescription = 'প্রথম কেনাকাটার জন্য, ৫০০ টাকার উপরে প্রযোজ্য';
        let lastMinPurchase = '500';
        let lastDiscount = '10';
        let lastQuantity = '1';
        let latestGeneratedCoupons = []; // New array to store generated coupons for batch download

        // --- Utility Functions ---
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Function to download a single generated coupon card as PNG
        async function downloadCouponCardAsPNG(cardElementId, code) {
            const card = document.getElementById(cardElementId);
            if (!card) {
                console.error("Coupon card element not found:", cardElementId);
                return;
            }

            try {
                // html2canvas options updated to improve capture quality and handling of QR code
                const canvas = await html2canvas(card, {
                    scale: 3, 
                    useCORS: true,
                    // Fix: Set explicit width/height on the element to capture its actual size
                    width: card.offsetWidth,
                    height: card.offsetHeight,
                    backgroundColor: null 
                });

                const image = canvas.toDataURL("image/png");
                
                const link = document.createElement('a');
                link.download = `${code}_Coupon_Card.png`;
                link.href = image;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Error generating or downloading coupon card:", error);
            }
        }
        
        // Function to download ALL generated coupon cards sequentially
        async function downloadAllGeneratedCoupons(coupons) {
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            if (!downloadAllBtn) return; // Add check for safety

            downloadAllBtn.disabled = true;
            downloadAllBtn.textContent = `ডাউনলোড চলছে... অনুগ্রহ করে অপেক্ষা করুন।`;

            for (const coupon of coupons) {
                const cardElementId = `coupon_card_${coupon.code}`;
                
                // Ensure QR code is re-rendered/available (important for batch operations)
                renderLargeQr(`qr_${coupon.code}`, coupon.code);
                
                // Use the individual download function
                await downloadCouponCardAsPNG(cardElementId, coupon.code);
                
                // Crucial: Add a small delay between downloads to prevent browser file-access issues
                await delay(500); 
            }

            downloadAllBtn.disabled = false;
            // Update button text after completion
            downloadAllBtn.innerHTML = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> সব কুপন একবারে ডাউনলোড করুন (${coupons.length} টি)`;
        }

        // Function to create a large QR code inside a specific element
        function renderLargeQr(elementId, code) {
            const qrcodeDiv = document.getElementById(elementId);
            if (!qrcodeDiv) return; // Add check for safety
            
            // Crucial: Clear the previous content before creating a new QR code
            qrcodeDiv.innerHTML = ''; 
            new QRCode(qrcodeDiv, {
                text: code,
                width: 128,
                height: 128,
                colorDark: "#1f2937", // Gray-800
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                    }
                    const userIdDisplay = document.getElementById('userIdDisplay');
                    if (userIdDisplay) {
                        userIdDisplay.textContent = userId;
                    }
                    loadTabContent('generate');
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('contentArea').innerHTML = `<p class="text-red-600 font-bold text-center">Firebase সংযোগ স্থাপন করা যায়নি। আপনার কনফিগারেশন সঠিক কিনা তা পরীক্ষা করুন।</p>`;
            }
        }

        // --- Coupon Generation ---
        function generateCouponCode(length = 8) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        async function saveCoupon(couponData) {
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/coupons`), couponData);
                return { success: true, id: docRef.id };
            } catch (error) {
                console.error("Error saving coupon:", error);
                return { success: false };
            }
        }

        // Removed the download button from the card HTML
        function renderCouponCardHtml(coupon, isSingle) {
            const cardId = `coupon_card_${coupon.code}`;
            const qrId = `qr_${coupon.code}`;
            const expiryDate = new Date(coupon.expiryDate).toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Updated HTML structure with increased card size
            const html = `
                <div id="${cardId}" class="coupon-card-download text-white font-sans transition-all duration-300">
                    <div class="coupon-content-wrapper flex flex-col justify-between h-full">
                        
                        <div class="mb-4">
                            <div class="text-xs font-light tracking-wider opacity-90">উপহার কুপন:</div>
                            <h2 class="text-3xl md:text-4xl font-extrabold mb-1 tracking-tight leading-tight">${coupon.discount}% ডিসকাউন্ট</h2>
                            <p class="text-sm font-medium opacity-90 break-words">${coupon.title}</p>
                        </div>

                        <div class="flex items-end justify-between space-x-4"> 
                            <div class="qr-code-large bg-white p-1 rounded-lg flex-shrink-0 shadow-md">
                                <div id="${qrId}"></div>
                            </div>
                            
                            <div class="text-right min-w-0 flex-grow">
                                <div class="text-base font-light mb-1 opacity-90">কুপন কোড:</div>
                                <div class="text-4xl font-mono font-bold tracking-widest leading-none text-white break-all">${coupon.code}</div>
                                <div class="mt-2 text-xs font-light opacity-80">
                                    <p>ন্যূনতম কেনাকাটা: ${coupon.minPurchase} টাকা</p>
                                    <p>মেয়াদ শেষ: ${expiryDate}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function renderGenerateTab() {
            const today = new Date().toISOString().split('T')[0];
            
            const content = `
                <h2 class="text-2xl font-bold text-emerald-600 mb-6 border-b pb-2">নতুন কুপন তৈরি করুন</h2>
                <form id="couponForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="couponTitle" class="block text-gray-700 font-medium mb-2">কুপন টাইটেল/নাম <span class="text-red-500">*</span></label>
                        <input type="text" id="couponTitle" placeholder="যেমন: ঈদ স্পেশাল ডিসকাউন্ট" value="${lastTitle}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                    </div>
                    <div>
                        <label for="discountAmount" class="block text-gray-700 font-medium mb-2">ডিসকাউন্ট পরিমাণ (%) <span class="text-red-500">*</span></label>
                        <input type="number" id="discountAmount" value="${lastDiscount}" min="1" max="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                    </div>
                    <div>
                        <label for="minPurchase" class="block text-gray-700 font-medium mb-2">ন্যূনতম কেনাকাটার পরিমাণ (টাকা)</label>
                        <input type="number" id="minPurchase" value="${lastMinPurchase}" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="expiryDate" class="block text-gray-700 font-medium mb-2">মেয়াদ শেষের তারিখ <span class="text-red-500">*</span></label>
                        <input type="date" id="expiryDate" value="${today}" min="${today}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block text-gray-700 font-medium mb-2">কুপন বর্ণনা (ঐচ্ছিক)</label>
                        <input type="text" id="description" placeholder="যেমন: প্রথম কেনাকাটার জন্য, ৫০০ টাকার উপরে প্রযোজ্য" value="${lastDescription}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="quantity" class="block text-gray-700 font-medium mb-2">তৈরি করার সংখ্যা (১ - ২০)</label>
                        <input type="number" id="quantity" value="${lastQuantity}" min="1" max="20" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2 mt-4">
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition duration-150 transform hover:scale-[1.01] shadow-lg">
                            কুপন তৈরি ও সংরক্ষণ করুন
                        </button>
                    </div>
                </form>

                <div id="generationResult" class="mt-8 p-6 bg-emerald-50 border-l-4 border-emerald-500 rounded-lg hidden">
                    <p class="font-semibold text-emerald-800 mb-4" id="resultHeader">সফলভাবে তৈরি কুপন:</p>
                    
                    <button id="downloadAllBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] shadow-lg mb-6 flex items-center justify-center hidden">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        সব কুপন একবারে ডাউনলোড করুন (<span id="downloadCount"></span> টি)
                    </button>
                    <div id="couponDisplay" class="text-center space-y-4">
                        </div>
                </div>
            `;
            document.getElementById('contentArea').innerHTML = content;

            document.getElementById('couponForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                // Get all input values
                const title = document.getElementById('couponTitle').value.trim();
                const amount = document.getElementById('discountAmount').value;
                const expiry = document.getElementById('expiryDate').value;
                const description = document.getElementById('description').value;
                const minPurchase = document.getElementById('minPurchase').value || '0';
                const quantity = parseInt(document.getElementById('quantity').value || 1);

                if (!title || !amount || !expiry) {
                    console.error('দয়া করে কুপন টাইটেল, ডিসকাউন্ট এবং মেয়াদ শেষের তারিখ দিন।');
                    return;
                }

                const resultDiv = document.getElementById('generationResult');
                const displayDiv = document.getElementById('couponDisplay');
                const resultHeader = document.getElementById('resultHeader');

                let successCount = 0;
                let generatedCoupons = []; 
                latestGeneratedCoupons = []; // Reset global list

                // Update Persistence Variables
                lastTitle = title;
                lastDescription = description;
                lastMinPurchase = minPurchase;
                lastDiscount = amount;
                lastQuantity = quantity.toString();


                // Batch Generation Logic
                for (let i = 0; i < quantity; i++) {
                    const code = generateCouponCode(8); 
                    const couponData = {
                        title: title, 
                        code: code,
                        discount: parseInt(amount),
                        expiryDate: expiry,
                        description: description,
                        minPurchase: parseInt(minPurchase), 
                        isUsed: false,
                        createdAt: new Date().toISOString()
                    };

                    const saveResult = await saveCoupon(couponData);

                    if (saveResult.success) {
                        successCount++;
                        generatedCoupons.push({ ...couponData, id: saveResult.id });
                    } else {
                        console.error(`Failed to save coupon instance ${i + 1}`);
                    }
                }

                latestGeneratedCoupons = generatedCoupons; // Store the list for batch download

                if (resultDiv) {
                    resultDiv.classList.remove('hidden');
                }
                

                if (successCount > 0) {
                    
                    if (resultHeader) { // Added null check
                         resultHeader.textContent = `${successCount} টি কুপন সফলভাবে তৈরি হয়েছে:`;
                    }
                    
                    // Show Batch Download Button and attach handler
                    const downloadAllBtn = document.getElementById('downloadAllBtn');
                    const downloadCountSpan = document.getElementById('downloadCount'); // Get the span element
                    
                    if (downloadCountSpan) { // Added null check
                        downloadCountSpan.textContent = successCount;
                    }
                    
                    if (downloadAllBtn) { // Added null check
                        downloadAllBtn.classList.remove('hidden');
                        downloadAllBtn.onclick = () => downloadAllGeneratedCoupons(latestGeneratedCoupons); // Attach handler
                    }
                    
                    let cardHtml = '';
                    
                    // Render the large coupon card for each generated coupon
                    generatedCoupons.forEach(coupon => {
                        cardHtml += renderCouponCardHtml(coupon, successCount === 1);
                    });
                    
                    if (displayDiv) {
                         displayDiv.innerHTML = cardHtml;
                    }
                   
                    
                    // Render QR codes
                    generatedCoupons.forEach(coupon => {
                        const qrId = `qr_${coupon.code}`;
                        // Delay QR rendering slightly to ensure the canvas element is fully available
                        setTimeout(() => {
                            renderLargeQr(qrId, coupon.code);
                        }, 50); 
                    });
                    
                } else {
                    if (downloadAllBtn) {
                        document.getElementById('downloadAllBtn').classList.add('hidden');
                    }
                    if (resultHeader) {
                        resultHeader.textContent = 'তৈরির ফলাফল:';
                    }
                    if (displayDiv) {
                         displayDiv.innerHTML = `<p class="text-red-600 font-bold">কোনো কুপন সংরক্ষণ করা সম্ভব হয়নি।</p>`;
                    }
                   
                }
            });
        }

        // --- Coupon Validation (Unchanged) ---
        async function getCouponByCode(code) {
            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/coupons`),
                where("code", "==", code),
                limit(1)
            );
            const querySnapshot = await getDocs(q); 
            if (!querySnapshot.empty) {
                return querySnapshot.docs[0];
            }
            return null;
        }

        async function validateCoupon(e) {
            e.preventDefault();
            const inputCode = document.getElementById('validateInput').value.toUpperCase().trim();
            const validatorResult = document.getElementById('validatorResult');
            const validateBtn = document.getElementById('validateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!inputCode) {
                if (validatorResult) { // Added null check
                    validatorResult.innerHTML = `<p class="text-red-600 font-semibold">কুপন কোড দিন।</p>`;
                    validatorResult.classList.remove('hidden');
                }
                return;
            }

            if (validateBtn) { // Added null check
                validateBtn.disabled = true;
            }
            if (loadingIndicator) { // Added null check
                loadingIndicator.classList.remove('hidden');
            }
            if (validatorResult) { // Added null check
                validatorResult.classList.add('hidden');
            }
            

            try {
                const couponDoc = await getCouponByCode(inputCode);

                if (validatorResult) { // Added null check
                     if (!couponDoc) {
                        validatorResult.innerHTML = `<p class="text-red-600 font-bold">কুপন কোডটি খুঁজে পাওয়া যায়নি।</p>`;
                    } else {
                        const couponData = couponDoc.data();
                        const expiry = new Date(couponData.expiryDate);

                        if (couponData.isUsed) {
                            validatorResult.innerHTML = `<p class="text-yellow-600 font-semibold">এই কুপনটি ইতিমধ্যে ব্যবহার করা হয়ে গেছে।</p>`;
                        } else if (new Date() > expiry) {
                            validatorResult.innerHTML = `<p class="text-yellow-600 font-semibold">এই কুপনটির মেয়াদ শেষ হয়ে গেছে।</p>`;
                        } else {
                            // কোডটি সফলভাবে ব্যবহার করা হলো, এখন ডেটাবেস আপডেট হবে
                            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/coupons`, couponDoc.id), {
                                isUsed: true,
                                usageDate: new Date().toISOString()
                            }); 

                            validatorResult.innerHTML = `<p class="text-green-600 font-bold">কুপন সফলভাবে ব্যবহার করা হয়েছে! ডিসকাউন্ট প্রযোজ্য হবে।</p>`;
                        }
                    }
                }
               
            } catch (error) {
                console.error("Validation error:", error);
                if (validatorResult) { // Added null check
                     validatorResult.innerHTML = `<p class="text-red-600 font-bold">ভ্যালিডেশনে একটি সমস্যা হয়েছে।</p>`;
                }
            } finally {
                if (validateBtn) { // Added null check
                    validateBtn.disabled = false;
                }
                if (loadingIndicator) { // Added null check
                    loadingIndicator.classList.add('hidden');
                }
                if (validatorResult) { // Added null check
                    validatorResult.classList.remove('hidden');
                }
            }
        }

        function renderValidateTab() {
            const content = `
                <h2 class="text-2xl font-bold text-emerald-600 mb-6 border-b pb-2">কুপন ভ্যালিডেট করুন</h2>
                <form id="validateForm" class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="validateInput" class="block text-gray-700 font-medium mb-2">কুপন কোড লিখুন</label>
                        <input type="text" id="validateInput" placeholder="যেমন: XYZ123ABC456" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 uppercase" required>
                    </div>
                    <button type="submit" id="validateBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01] shadow-lg flex items-center justify-center">
                        <svg id="loadingIndicator" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ভ্যালিডেট করুন
                    </button>
                </form>

                <div id="validatorResult" class="mt-8 p-6 text-center bg-gray-100 rounded-lg hidden border-l-4 border-gray-400">
                    </div>
            `;
            document.getElementById('contentArea').innerHTML = content;
            document.getElementById('validateForm').addEventListener('submit', validateCoupon);
        }

        // --- Coupon List ---
        function renderListTab() {
            const content = `
                <h2 class="text-2xl font-bold text-emerald-600 mb-6 border-b pb-2">কুপন তালিকা</h2>
                <div class="overflow-x-auto bg-gray-50 p-4 rounded-lg shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">টাইটেল</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">কোড</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ডিসকাউন্ট (%)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ন্যূনতম কেনাকাটা</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">মেয়াদ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">স্ট্যাটাস</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ব্যবহারের তারিখ</th>
                            </tr>
                        </thead>
                        <tbody id="couponListBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">কুপন লোড হচ্ছে...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('contentArea').innerHTML = content;
            loadCouponList();
        }

        // --- Load Coupon List (Unchanged) ---
        function loadCouponList() {
            if (!db || !userId) {
                setTimeout(loadCouponList, 500); // Retry if not ready
                return;
            }

            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/coupons`)
            );

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const coupons = [];
                snapshot.forEach((doc) => {
                    coupons.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (newest first) in JavaScript
                coupons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const tbodyList = document.getElementById('couponListBody'); // Main List tab body (7 columns)

                const emptyRowList = `<tr><td colspan="7" class="text-center py-4 text-gray-500">কোনো কুপন পাওয়া যায়নি।</td></tr>`;

                const createTableRows = (coupons, isFullTable) => {
                    return coupons.map(coupon => {
                        const statusText = coupon.isUsed ? 'ব্যবহৃত' : (new Date(coupon.expiryDate) < new Date() ? 'মেয়াদ উত্তীর্ণ' : 'সক্রিয়');
                        let statusColor = 'bg-red-100 text-red-800';
                        if (coupon.isUsed) {
                            statusColor = 'bg-yellow-100 text-yellow-800';
                        } else if (new Date(coupon.expiryDate) >= new Date()) {
                            statusColor = 'bg-green-100 text-green-800';
                        }

                        const usageDate = coupon.usageDate ? new Date(coupon.usageDate).toLocaleDateString('bn-BD') : 'ব্যবহার হয়নি';
                        const minPurchaseText = coupon.minPurchase ? `${coupon.minPurchase} টাকা` : '—';
                        
                        let cells = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${coupon.title || '—'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 font-mono">${coupon.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${coupon.discount}%</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${minPurchaseText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(coupon.expiryDate).toLocaleDateString('bn-BD')}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${usageDate}</td>
                        `;

                        return `<tr class="hover:bg-gray-50 transition duration-100">${cells}</tr>`;
                    }).join('');
                };

                // Update the main List tab body (7 columns)
                if (tbodyList) {
                    tbodyList.innerHTML = coupons.length > 0 ? createTableRows(coupons, true) : emptyRowList;
                }

            }, (error) => {
                console.error("Error loading coupon list:", error);
                if (tbodyList) {
                    tbodyList.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">কুপন লোড করতে সমস্যা হয়েছে।</td></tr>`;
                }
            });
        }


        // --- Tab Control Logic ---
        let currentTab = 'generate';

        function loadTabContent(tabName) {
            const contentArea = document.getElementById('contentArea');
            const tabButtons = document.querySelectorAll('.tab-btn');

            tabButtons.forEach(btn => btn.classList.remove('active'));

            if (tabName === 'generate') {
                renderGenerateTab();
                document.getElementById('tabGenerate').classList.add('active');
            } else if (tabName === 'validate') {
                renderValidateTab();
                document.getElementById('tabValidate').classList.add('active');
            } else if (tabName === 'list') {
                renderListTab();
                document.getElementById('tabList').classList.add('active');
            }
            currentTab = tabName;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tabGenerate').addEventListener('click', () => loadTabContent('generate'));
            document.getElementById('tabValidate').addEventListener('click', () => loadTabContent('validate'));
            document.getElementById('tabList').addEventListener('click', () => loadTabContent('list'));

            initFirebase();
        });

    </script>
</body>
</html>
